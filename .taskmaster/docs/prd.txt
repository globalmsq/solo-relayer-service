# MSQ Relayer Service - Product Requirements Document (PRD)

## Document Information

- **Version**: 12.0
- **Last Updated**: 2025-12-15
- **Purpose**: Requirements document for Task Master AI parsing

## Related Documents (See below for detailed implementation)

- Technical Stack and API Details: [docs/tech.md](../docs/tech.md)
- System Architecture: [docs/structure.md](../docs/structure.md)
- Product Overview: [docs/product.md](../docs/product.md)

---

## 1. Executive Summary

### 1.1 Background

In preparation for OpenZeppelin Defender service discontinuation (July 2026), building a self-hosted Blockchain Transaction Relayer System utilizing **OZ open source (Relayer + Monitor)**

> **Note**: MSQ Relayer Service is **B2B Infrastructure**. End Users do not use it directly; internal Client Services (payment system, airdrop system, NFT services, etc.) call the Relayer API.

### 1.2 Core Strategy

| Component | Version | Role |
|-----------|---------|------|
| **OZ Relayer** | v1.3.0 (Rust, Docker) | Transaction relay, Nonce management, Gas estimation, Retry logic |
| **OZ Monitor** | v1.1.0 (Rust, Docker) | Blockchain event monitoring, Balance alerts |
| **NestJS API Gateway** | 10.x | Authentication, Policy engine, API documentation (Swagger/OpenAPI) |

### 1.3 Core Features

**Phase 1**:
- Direct Transaction: Automated transaction execution through OZ Relayer
- Gasless Transaction: Client Service receives End User signature and forwards to Relayer (Payment system Gasless payments)
- ERC2771Forwarder deployment and EIP-712 signature verification
- Multi-Relayer Pool: Independent Private Key based parallel processing (Scale In/Out support)

**Phase 2+**:
- Queue System: Redis(BullMQ) or AWS SQS based transaction queue (QUEUE_PROVIDER setting)
- Policy Engine: Contract/Method Whitelist, Blacklist
- Monitor Service: Blockchain event monitoring and alerts through OZ Monitor

### 1.4 Phase 1 Goal: Payment System Integration

- Integration with **Payment System** as first Client Service
- Token transfer/settlement processing through Direct TX
- User gas fee subsidy payments through Gasless TX
- ERC2771Forwarder deployment and EIP-712 signature verification
- Production-level API Gateway implementation

---

## 2. Target Users

> **Note**: MSQ Relayer Service is **B2B Infrastructure**.

### 2.1 Client Services (Primary)

| Client Service | Main Usage Pattern |
|----------------|-------------------|
| **Payment System** | Direct TX - Bulk token transfers, Settlement |
| **Airdrop System** | Direct TX - Batch processing, Scheduling |
| **NFT Service** | Gasless TX - End User gas fee subsidy |
| **DeFi Service** | Direct TX - Automated transactions |
| **Game Service** | Gasless TX - Seamless UX provision |

### 2.2 Internal Users (Operations/Development)

- DevOps Engineers: System monitoring and Relayer Pool management
- Backend Developers: API integration and smart contract deployment
- Security Officers: Policy management and auditing

---

## 3. Functional Requirements

### 3.1 Phase 1: Direct TX + Gasless TX + Multi-Relayer Pool

**Infrastructure**:
- [ ] Docker Compose (OZ Relayer Pool + Redis)
- [ ] OZ Relayer configuration files (individual config.json per Relayer)
- [ ] Local development environment setup

**Multi-Relayer Pool**:
- [ ] Relayer Pool configuration file (relayer-pool.yaml)
- [ ] Relayer Registry module (Pool management)
- [ ] Health Check module (individual Relayer status check)
- [ ] Load Balancer module (Round Robin / Least Load)
- [ ] Manual Scaling support (Docker Compose profile)

**Smart Contracts**:
- [ ] ERC2771Forwarder deployment (OpenZeppelin)
- [ ] Sample Contracts (ERC20/ERC721 + ERC2771Context)

**API Gateway (Production Level)**:
- [ ] NestJS project scaffold
- [ ] API Key authentication module
- [ ] Health Check endpoint
- [ ] Direct TX endpoint (`/api/v1/relay/direct`)
- [ ] Gasless TX endpoint (`/api/v1/relay/gasless`)
- [ ] Nonce query endpoint (`/api/v1/relay/nonce/{address}`)
- [ ] OZ Relayer proxy service
- [ ] Transaction status query (`/api/v1/relay/status/{txId}`) - Polling method
- [ ] EIP-712 signature verification (Gasless TX pre-validation)

**Payment System Integration**:
- [ ] Direct TX: Payment system API integration testing
- [ ] Gasless TX: End User gas fee subsidy payment flow verification
- [ ] End User EIP-712 signature -> Payment system -> Relayer API flow

### 3.2 Phase 2+: Future Implementation

**TX History & Webhook (P1)**:
- [ ] MySQL (Transaction History storage)
- [ ] Webhook handler (OZ Relayer status notification processing)
- [ ] Status change Push notifications

**Queue System (P1)**:
- [ ] Queue Adapter pattern (QUEUE_PROVIDER setting)
- [ ] Redis + BullMQ implementation (default)
- [ ] AWS SQS implementation (optional)
- [ ] Job status tracking API (`/api/v1/relay/job/{jobId}`)
- [ ] 202 Accepted response + Job ID return

**Policy Engine (P1)**:
- [ ] Contract Whitelist verification
- [ ] User Blacklist

**Monitor Service (P2)**:
- [ ] OZ Monitor setup
- [ ] Relayer balance monitoring
- [ ] Slack/Discord alerts

**Auto Scaling (P2)**:
- [ ] Kubernetes HPA based auto scaling
- [ ] Queue Depth based scaling trigger
- [ ] Relayer Pool automatic scale out/in

**Infrastructure Enhancement (P2)**:
- [ ] Kubernetes manifests
- [ ] CI/CD pipeline
- [ ] Grafana dashboard

---

## 4. API Requirements (Summary)

> Detailed API Spec: [docs/tech.md Section 5](../docs/tech.md#5-api-specifications)

### 4.1 Phase 1 Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/v1/relay/direct` | Direct Transaction execution |
| POST | `/api/v1/relay/gasless` | Gasless Transaction execution |
| GET | `/api/v1/relay/nonce/{address}` | Nonce query |
| GET | `/api/v1/relay/status/{txId}` | Transaction status query |
| GET | `/api/v1/health` | Health Check |

### 4.2 Response Format

- Maintain OZ Defender SDK compatible format
- Transaction status: `pending` -> `sent` -> `submitted` -> `inmempool` -> `mined` -> `confirmed`

---

## 5. Supported Blockchain Networks

| Network | Chain ID | Type | Forwarder Deployment | Priority |
|---------|----------|------|---------------------|----------|
| Hardhat Node | 31337 | Local Dev | Auto deploy | P0 |
| Polygon Amoy | 80002 | Testnet | Pre-deployed | P0 |
| Polygon Mainnet | 137 | Mainnet | Pre-deployed | P0 |
| Ethereum Sepolia | 11155111 | Testnet | Pre-deployed | P1 |
| Ethereum Mainnet | 1 | Mainnet | Pre-deployed | P1 |
| BNB Chain | 56 | Mainnet | Pre-deployed | P2 |

---

## 6. Milestones & Acceptance Criteria

### 6.1 Phase 1 Milestones (5 Weeks)

**Week 1: Infrastructure + API Gateway Basics**
- Docker Compose setup (OZ Relayer + Redis)
- OZ Relayer configuration (Polygon Amoy/Mainnet)
- NestJS project scaffold
- API Key authentication module
- Health Check endpoint

**Week 2: Direct TX API**
- `/api/v1/relay/direct` endpoint
- OZ Relayer proxy service
- Transaction status query API (polling method)

**Week 3: Smart Contracts + Gasless TX API**
- ERC2771Forwarder deployment (Polygon Amoy/Mainnet)
- Sample Contracts (ERC20/ERC721 + ERC2771Context)
- `/api/v1/relay/gasless` endpoint
- `/api/v1/relay/nonce/{address}` endpoint

**Week 4: EIP-712 Verification + Payment System Integration**
- EIP-712 signature verification implementation
- Direct TX payment system integration
- Gasless TX payment system integration (End User gas fee subsidy)

**Week 5: Production Stabilization + Documentation**
- Integration testing and bug fixes
- Production environment configuration
- API documentation
- Operations guide

### 6.2 Acceptance Criteria

- [ ] Direct TX API works correctly and is callable from payment system
- [ ] Gasless TX API verifies End User signature and executes transaction
- [ ] Health Check accurately returns all Relayer statuses
- [ ] Transaction status query enables real-time polling
- [ ] API documentation (Swagger) accessible at `/api/docs`

---

## 7. Risks & Mitigation Strategies

| Risk | Impact | Mitigation Strategy |
|------|--------|---------------------|
| OZ Relayer bug | Transaction failure | Custom retry logic + Monitoring |
| Gas price surge | Cost increase | Gas cap policy + Alerts |
| Private Key exposure | Fund loss | AWS KMS (prod), Access control |
| Network failure | Service outage | Multi-Relayer Pool, Fallback RPC |
| Nonce conflict | Transaction failure | OZ Relayer built-in Nonce management |

---

## 8. Success Metrics (KPIs)

| Metric | Target Value |
|--------|--------------|
| Transaction success rate | >= 99.5% |
| Response time (P95) | < 3 seconds |
| System availability | >= 99.9% |
| Gasless daily throughput | >= 10,000 TX |
| OZ service stability | >= 99.9% uptime |

---

## 9. References (Detailed Implementation Documents)

See the following documents for detailed implementation:

| Item | Reference Document |
|------|-------------------|
| **Directory Structure** | [docs/structure.md Section 3](../docs/structure.md#3-directory-structure-v50---spec-infra-001-standard) |
| **Docker Compose Configuration** | [docs/tech.md Section 13](../docs/tech.md#13-docker-compose-configuration-v50---spec-infra-001) |
| **API Detailed Spec** | [docs/tech.md Section 5](../docs/tech.md#5-api-specifications) |
| **Authentication Strategy** | [docs/tech.md Section 9](../docs/tech.md#9-security-requirements) |
| **Smart Contracts** | [docs/tech.md Section 3](../docs/tech.md#3-smart-contracts-technology-stack) |
| **OZ Relayer Configuration** | [docs/tech.md Section 11](../docs/tech.md#11-oz-relayer-configuration) |
| **OZ Monitor Configuration** | [docs/tech.md Section 12](../docs/tech.md#12-oz-monitor-configuration-phase-2) |
| **System Architecture** | [docs/structure.md Section 1](../docs/structure.md#1-system-architecture) |
| **Data Flow** | [docs/structure.md Section 5](../docs/structure.md#5-data-flow) |

---

## 10. License Considerations

### OZ Relayer / OZ Monitor: AGPL-3.0
- **Internal use**: No restrictions
- **Service provision**: Changes must be disclosed if modified
- **SaaS exception**: Source disclosure obligation when providing services over network

### OZ Contracts: MIT
- Commercial use allowed
- Free to modify and distribute

---

Version: 12.0
Last Updated: 2025-12-15

## HISTORY

| Version | Date | Changes |
|---------|------|---------|
| 12.0 | 2025-12-15 | Major PRD structure simplification - Restructured around requirements, moved implementation details (directory structure, Docker Compose YAML, authentication strategy details, OZ config examples) to docs/, reduced from 572 lines to ~280 lines (51% reduction), added Section 9 References for detailed document links |
| 11.4 | 2025-12-15 | Section 9.3 Docker Compose YAML Anchors structure fix - moved x-relayer-common to top level outside services block, added healthcheck/networks, applied correct YAML Anchors syntax |
| 11.3 | 2025-12-15 | Section 1.5 Supported blockchain networks changed to table format - added Hardhat Node (31337, Local Dev, P0), specified Chain ID, synchronized with product.md Section 5 |
| 11.2 | 2025-12-15 | Applied Docker Compose YAML Anchors pattern - minimized Multi-Relayer Pool config duplication, explained why deploy.replicas not used (individual Private Keys required) |
| 11.1 | 2025-12-15 | Section 8.1 API Key authentication added - Phase 1 single environment variable method (RELAY_API_KEY), Phase 2+ expansion plan specified |
| 11.0 | 2025-12-15 | SPEC-INFRA-001 based Docker structure sync - consolidated to docker/ directory, multi-stage build, .env removal, Hardhat Node included, Redis 8.0-alpine (AOF), Named Volume (msq-relayer-redis-data), OZ Relayer RPC_URL/REDIS_HOST/REDIS_PORT, Read-only volume mounts |
| 10.0 | 2025-12-15 | MySQL/Prisma moved to Phase 2+ - Phase 1 uses only OZ Relayer + Redis, no DB, removed mysql from Docker Compose |
| 9.0 | 2025-12-15 | TX History, Webhook Handler moved to Phase 2+ - Phase 1 uses status polling method, MySQL/Webhook implemented in Phase 2+ |
| 8.0 | 2025-12-15 | Rate Limiting, Quota Manager completely removed - Phase 1 keeps only Auth + Relay functionality, Policy & Quota changed to Policy Engine, quota management removed |
| 7.0 | 2025-12-15 | Phase 2 redesign - Rate Limiting removed, Queue System added (QUEUE_PROVIDER: Redis/SQS), SDK removed and replaced with API documentation (Swagger/OpenAPI) |
| 6.1 | 2025-12-15 | Multi-Relayer Pool added - Phase 1 includes Relayer Pool structure, independent Private Key based parallel processing, Load Balancing (Round Robin/Least Load), Manual Scaling Phase 1, Auto Scaling Phase 2+ |
| 6.0 | 2025-12-15 | Gasless TX included in Phase 1 - Payment system Gasless payment support, ERC2771Forwarder/EIP-712 verification moved to Phase 1, Policy/Quota remains Phase 2, 5-week milestone |
| 5.0 | 2025-12-14 | Reorganized around Phase 1 - Changed MVP terminology to Phase 1, Payment system integration goal, Gasless/Monitor separated to Phase 2+ |
| 4.0 | 2025-12-13 | Complete rewrite from B2B Infrastructure perspective |
| 3.0 | 2025-12-13 | Complete redesign to OZ open source based architecture |
