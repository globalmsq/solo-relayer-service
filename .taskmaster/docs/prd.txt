# MSQ Relayer Service - Product Requirements Document (PRD)

## 문서 정보

- **버전**: 12.0
- **최종 수정일**: 2025-12-15
- **목적**: Task Master AI 파싱용 요구사항 문서

## 관련 문서 (상세 구현은 아래 참조)

- 기술 스택 및 API 상세: [docs/tech.md](../docs/tech.md)
- 시스템 아키텍처: [docs/structure.md](../docs/structure.md)
- 제품 개요: [docs/product.md](../docs/product.md)

---

## 1. Executive Summary

### 1.1 배경

OpenZeppelin Defender 서비스 종료(2026년 7월)에 대비하여, **OZ 오픈소스(Relayer + Monitor)**를 활용한 self-hosted Blockchain Transaction Relayer System 구축

> **참고**: MSQ Relayer Service는 **B2B Infrastructure**입니다. End User가 직접 사용하는 것이 아니라, 내부 Client Services (결제 시스템, 에어드랍 시스템, NFT 서비스 등)가 Relayer API를 호출합니다.

### 1.2 핵심 전략

| 컴포넌트 | 버전 | 역할 |
|----------|------|------|
| **OZ Relayer** | v1.3.0 (Rust, Docker) | 트랜잭션 중계, Nonce 관리, Gas 추정, 재시도 로직 |
| **OZ Monitor** | v1.1.0 (Rust, Docker) | 블록체인 이벤트 모니터링, 잔액 알림 |
| **NestJS API Gateway** | 10.x | 인증, 정책 엔진, API 문서화 (Swagger/OpenAPI) |

### 1.3 핵심 기능

**Phase 1**:
- Direct Transaction: OZ Relayer를 통한 자동화 트랜잭션 실행
- Gasless Transaction: Client Service가 End User 서명을 받아 Relayer에 전달 (결제 시스템 Gasless 결제)
- ERC2771Forwarder 배포 및 EIP-712 서명 검증
- Multi-Relayer Pool: 독립 Private Key 기반 병렬 처리 (Scale In/Out 지원)

**Phase 2+**:
- Queue System: Redis(BullMQ) 또는 AWS SQS 기반 트랜잭션 큐 (QUEUE_PROVIDER 설정)
- Policy Engine: Contract/Method Whitelist, Blacklist
- Monitor Service: OZ Monitor를 통한 블록체인 이벤트 모니터링 및 알림

### 1.4 Phase 1 목표: 결제 시스템 연동

- 첫 번째 Client Service로 **결제 시스템** 연동
- Direct TX를 통한 토큰 전송/정산 처리
- Gasless TX를 통한 사용자 가스비 대납 결제
- ERC2771Forwarder 배포 및 EIP-712 서명 검증
- 프로덕션 레벨 API Gateway 구현

---

## 2. 대상 사용자

> **참고**: MSQ Relayer Service는 **B2B Infrastructure**입니다.

### 2.1 Client Services (Primary)

| 클라이언트 서비스 | 주요 사용 패턴 |
|------------------|---------------|
| **결제 시스템** | Direct TX - 대량 토큰 전송, 정산 |
| **에어드랍 시스템** | Direct TX - 배치 처리, 스케줄링 |
| **NFT 서비스** | Gasless TX - End User 가스비 대납 |
| **DeFi 서비스** | Direct TX - 자동화 트랜잭션 |
| **게임 서비스** | Gasless TX - 원활한 UX 제공 |

### 2.2 Internal Users (운영/개발)

- DevOps 엔지니어: 시스템 모니터링 및 Relayer Pool 관리
- 백엔드 개발자: API 연동 및 스마트 컨트랙트 배포
- 보안 담당자: Policy 관리 및 감사

---

## 3. Functional Requirements

### 3.1 Phase 1: Direct TX + Gasless TX + Multi-Relayer Pool

**Infrastructure**:
- [ ] Docker Compose (OZ Relayer Pool + Redis)
- [ ] OZ Relayer 설정 파일 (개별 Relayer별 config.json)
- [ ] 로컬 개발 환경 구성

**Multi-Relayer Pool**:
- [ ] Relayer Pool 설정 파일 (relayer-pool.yaml)
- [ ] Relayer Registry 모듈 (Pool 관리)
- [ ] Health Check 모듈 (각 Relayer 상태 체크)
- [ ] Load Balancer 모듈 (Round Robin / Least Load)
- [ ] Manual Scaling 지원 (Docker Compose profile)

**Smart Contracts**:
- [ ] ERC2771Forwarder 배포 (OpenZeppelin)
- [ ] Sample Contracts (ERC20/ERC721 + ERC2771Context)

**API Gateway (프로덕션 레벨)**:
- [ ] NestJS 프로젝트 스캐폴드
- [ ] API Key 인증 모듈
- [ ] Health Check 엔드포인트
- [ ] Direct TX 엔드포인트 (`/api/v1/relay/direct`)
- [ ] Gasless TX 엔드포인트 (`/api/v1/relay/gasless`)
- [ ] Nonce 조회 엔드포인트 (`/api/v1/relay/nonce/{address}`)
- [ ] OZ Relayer 프록시 서비스
- [ ] 트랜잭션 상태 조회 (`/api/v1/relay/status/{txId}`) - 폴링 방식
- [ ] EIP-712 서명 검증 (Gasless TX 사전 검증)

**결제 시스템 연동**:
- [ ] Direct TX: 결제 시스템 API 연동 테스트
- [ ] Gasless TX: End User 가스비 대납 결제 플로우 검증
- [ ] End User EIP-712 서명 -> 결제 시스템 -> Relayer API 플로우

### 3.2 Phase 2+: 추후 구현

**TX History & Webhook (P1)**:
- [ ] MySQL (Transaction History 저장)
- [ ] Webhook 핸들러 (OZ Relayer 상태 알림 처리)
- [ ] 상태 변경 Push 알림

**Queue System (P1)**:
- [ ] Queue Adapter 패턴 (QUEUE_PROVIDER 설정)
- [ ] Redis + BullMQ 구현 (기본)
- [ ] AWS SQS 구현 (옵션)
- [ ] Job 상태 추적 API (`/api/v1/relay/job/{jobId}`)
- [ ] 202 Accepted 응답 + Job ID 반환

**Policy Engine (P1)**:
- [ ] Contract Whitelist 검증
- [ ] User Blacklist

**Monitor Service (P2)**:
- [ ] OZ Monitor 설정
- [ ] Relayer 잔액 모니터링
- [ ] Slack/Discord 알림

**Auto Scaling (P2)**:
- [ ] Kubernetes HPA 기반 자동 스케일링
- [ ] Queue Depth 기반 스케일링 트리거
- [ ] Relayer Pool 자동 확장/축소

**Infrastructure 고도화 (P2)**:
- [ ] Kubernetes 매니페스트
- [ ] CI/CD 파이프라인
- [ ] Grafana 대시보드

---

## 4. API Requirements (Summary)

> 상세 API 스펙: [docs/tech.md Section 5](../docs/tech.md#5-api-사양)

### 4.1 Phase 1 엔드포인트

| Method | Endpoint | 설명 |
|--------|----------|------|
| POST | `/api/v1/relay/direct` | Direct Transaction 실행 |
| POST | `/api/v1/relay/gasless` | Gasless Transaction 실행 |
| GET | `/api/v1/relay/nonce/{address}` | Nonce 조회 |
| GET | `/api/v1/relay/status/{txId}` | 트랜잭션 상태 조회 |
| GET | `/api/v1/health` | Health Check |

### 4.2 응답 포맷

- OZ Defender SDK 호환 포맷 유지
- 트랜잭션 상태: `pending` -> `sent` -> `submitted` -> `inmempool` -> `mined` -> `confirmed`

---

## 5. 지원 블록체인 네트워크

| Network | Chain ID | Type | Forwarder 배포 | 우선순위 |
|---------|----------|------|----------------|----------|
| Hardhat Node | 31337 | Local Dev | 자동 배포 | P0 |
| Polygon Amoy | 80002 | Testnet | 사전 배포 | P0 |
| Polygon Mainnet | 137 | Mainnet | 사전 배포 | P0 |
| Ethereum Sepolia | 11155111 | Testnet | 사전 배포 | P1 |
| Ethereum Mainnet | 1 | Mainnet | 사전 배포 | P1 |
| BNB Chain | 56 | Mainnet | 사전 배포 | P2 |

---

## 6. 마일스톤 & 수용 기준

### 6.1 Phase 1 마일스톤 (5주)

**Week 1: Infrastructure + API Gateway 기본**
- Docker Compose 구성 (OZ Relayer + Redis)
- OZ Relayer 설정 (Polygon Amoy/Mainnet)
- NestJS 프로젝트 스캐폴드
- API Key 인증 모듈
- Health Check 엔드포인트

**Week 2: Direct TX API**
- `/api/v1/relay/direct` 엔드포인트
- OZ Relayer 프록시 서비스
- 트랜잭션 상태 조회 API (폴링 방식)

**Week 3: Smart Contracts + Gasless TX API**
- ERC2771Forwarder 배포 (Polygon Amoy/Mainnet)
- Sample Contracts (ERC20/ERC721 + ERC2771Context)
- `/api/v1/relay/gasless` 엔드포인트
- `/api/v1/relay/nonce/{address}` 엔드포인트

**Week 4: EIP-712 검증 + 결제 시스템 연동**
- EIP-712 서명 검증 구현
- Direct TX 결제 시스템 연동
- Gasless TX 결제 시스템 연동 (End User 가스비 대납)

**Week 5: 프로덕션 안정화 + 문서화**
- 연동 테스트 및 버그 수정
- 프로덕션 환경 설정
- API 문서화
- 운영 가이드

### 6.2 수용 기준

- [ ] Direct TX API가 정상 작동하고 결제 시스템에서 호출 가능
- [ ] Gasless TX API가 End User 서명을 검증하고 트랜잭션 실행
- [ ] Health Check가 모든 Relayer 상태를 정확히 반환
- [ ] 트랜잭션 상태 조회가 실시간 폴링 가능
- [ ] API 문서(Swagger)가 `/api/docs`에서 접근 가능

---

## 7. 리스크 & 완화 전략

| 리스크 | 영향 | 완화 전략 |
|--------|------|----------|
| OZ Relayer 버그 | 트랜잭션 실패 | 자체 재시도 로직 + 모니터링 |
| Gas 가격 급등 | 비용 증가 | Gas cap 정책 + 알림 |
| Private Key 노출 | 자금 손실 | AWS KMS (prod), 접근 제어 |
| 네트워크 장애 | 서비스 중단 | Multi-Relayer Pool, 폴백 RPC |
| Nonce 충돌 | 트랜잭션 실패 | OZ Relayer 내장 Nonce 관리 |

---

## 8. 성공 지표 (KPIs)

| 지표 | 목표값 |
|------|--------|
| 트랜잭션 성공률 | >= 99.5% |
| 응답 시간 (P95) | < 3초 |
| 시스템 가용성 | >= 99.9% |
| Gasless 일일 처리량 | >= 10,000 TX |
| OZ 서비스 안정성 | >= 99.9% uptime |

---

## 9. References (상세 구현 문서)

상세 구현 사항은 아래 문서를 참조하세요:

| 항목 | 참조 문서 |
|------|----------|
| **디렉토리 구조** | [docs/structure.md Section 3](../docs/structure.md#3-디렉토리-구조-v50---spec-infra-001-기준) |
| **Docker Compose 설정** | [docs/tech.md Section 13](../docs/tech.md#13-docker-compose-설정-v50---spec-infra-001) |
| **API 상세 스펙** | [docs/tech.md Section 5](../docs/tech.md#5-api-사양) |
| **인증 전략** | [docs/tech.md Section 9](../docs/tech.md#9-보안-요구사항) |
| **Smart Contracts** | [docs/tech.md Section 3](../docs/tech.md#3-smart-contracts-기술-스택) |
| **OZ Relayer 설정** | [docs/tech.md Section 11](../docs/tech.md#11-oz-relayer-설정) |
| **OZ Monitor 설정** | [docs/tech.md Section 12](../docs/tech.md#12-oz-monitor-설정-phase-2) |
| **시스템 아키텍처** | [docs/structure.md Section 1](../docs/structure.md#1-시스템-아키텍처) |
| **데이터 플로우** | [docs/structure.md Section 5](../docs/structure.md#5-데이터-플로우) |

---

## 10. 라이선스 고려사항

### OZ Relayer / OZ Monitor: AGPL-3.0
- **내부 사용**: 제한 없음
- **서비스 제공**: 수정 시 변경 사항 공개 필요
- **SaaS 예외**: 네트워크를 통한 서비스 제공 시 소스 공개 의무

### OZ Contracts: MIT
- 상업적 사용 가능
- 수정 및 배포 자유

---

버전: 12.0
최종 수정일: 2025-12-15

## HISTORY

| 버전 | 날짜 | 변경사항 |
|------|------|----------|
| 12.0 | 2025-12-15 | PRD 구조 대폭 간소화 - 요구사항 중심으로 재구성, 구현 상세(디렉토리 구조, Docker Compose YAML, 인증 전략 상세, OZ 설정 예시)를 docs/로 이동, 572줄에서 약 280줄로 축소 (51% 감소), Section 9 References 추가로 상세 문서 연결 |
| 11.4 | 2025-12-15 | Section 9.3 Docker Compose YAML Anchors 구조 수정 - x-relayer-common을 services 블록 외부 최상위 레벨로 이동, healthcheck/networks 추가, 올바른 YAML Anchors 문법 적용 |
| 11.3 | 2025-12-15 | Section 1.5 지원 블록체인 네트워크 테이블 형식으로 변경 - Hardhat Node (31337, Local Dev, P0) 추가, Chain ID 명시, product.md Section 5와 동기화 |
| 11.2 | 2025-12-15 | Docker Compose YAML Anchors 패턴 적용 - Multi-Relayer Pool 설정 중복 최소화, deploy.replicas 미사용 이유 설명 (개별 Private Key 필요) |
| 11.1 | 2025-12-15 | Section 8.1 API Key 인증 추가 - Phase 1 단일 환경변수 방식 (API_GATEWAY_API_KEY), Phase 2+ 확장 계획 명시 |
| 11.0 | 2025-12-15 | SPEC-INFRA-001 기준 Docker 구조 동기화 - docker/ 디렉토리로 통합, 멀티스테이지 빌드, .env 제거, Hardhat Node 포함, Redis 8.0-alpine (AOF), Named Volume (msq-relayer-redis-data), OZ Relayer RPC_URL/REDIS_HOST/REDIS_PORT, Read-only 볼륨 마운트 |
| 10.0 | 2025-12-15 | MySQL/Prisma를 Phase 2+로 이동 - Phase 1은 OZ Relayer + Redis만 사용, DB 없음, Docker Compose에서 mysql 제거 |
| 9.0 | 2025-12-15 | TX History, Webhook Handler를 Phase 2+로 이동 - Phase 1은 상태 폴링 방식 사용, MySQL/Webhook은 Phase 2+에서 구현 |
| 8.0 | 2025-12-15 | Rate Limiting, Quota Manager 완전 제거 - Phase 1은 Auth + Relay 기능만 유지, Policy & Quota -> Policy Engine으로 변경, 할당량 관리 제거 |
| 7.0 | 2025-12-15 | Phase 2 재설계 - Rate Limiting 제거, Queue System 추가 (QUEUE_PROVIDER: Redis/SQS), SDK 제거 후 API 문서화로 대체 (Swagger/OpenAPI) |
| 6.1 | 2025-12-15 | Multi-Relayer Pool 추가 - Phase 1에 Relayer Pool 구조 포함, 독립 Private Key 기반 병렬 처리, Load Balancing (Round Robin/Least Load), Manual Scaling Phase 1, Auto Scaling Phase 2+ |
| 6.0 | 2025-12-15 | Phase 1에 Gasless TX 포함 - 결제 시스템 Gasless 결제 지원, ERC2771Forwarder/EIP-712 검증 Phase 1으로 이동, Policy/Quota는 Phase 2 유지, 5주 마일스톤 |
| 5.0 | 2025-12-14 | Phase 1 중심으로 재정리 - MVP 용어를 Phase 1로 변경, 결제 시스템 연동 목표, Gasless/Monitor를 Phase 2+로 분리 |
| 4.0 | 2025-12-13 | B2B Infrastructure 관점으로 전면 재작성 |
| 3.0 | 2025-12-13 | OZ 오픈소스 기반 아키텍처로 전면 재설계 |
